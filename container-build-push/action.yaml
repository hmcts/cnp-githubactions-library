name: 'Container Build and Push'
description: 'Build and push container images with multi-platform support'
author: 'HMCTS'

inputs:
  dockerfile:
    description: 'Path to the Dockerfile'
    required: false
    default: './Dockerfile'
  context:
    description: 'Build context path'
    required: false
    default: '.'
  registry:
    description: 'Container registry URL (e.g., myregistry.azurecr.io)'
    required: true
  registry-username:
    description: 'Container registry username or service principal ID'
    required: true
  registry-password:
    description: 'Container registry password or service principal secret'
    required: true
  image-name:
    description: 'Image name (e.g., myapp)'
    required: true
  image-tags:
    description: 'Space-separated list of tags (e.g., "latest v1.0.0")'
    required: false
    default: 'latest'
  build-args:
    description: 'List of build-time variables (newline-delimited KEY=value pairs)'
    required: false
    default: ''
  platforms:
    description: 'Comma-separated list of target platforms (e.g., linux/amd64,linux/arm64)'
    required: false
    default: 'linux/amd64'
  push:
    description: 'Push image to registry'
    required: false
    default: 'true'
  cache-from:
    description: 'External cache sources (e.g., type=gha)'
    required: false
    default: 'type=gha'
  cache-to:
    description: 'Cache export destinations (e.g., type=gha,mode=max)'
    required: false
    default: 'type=gha,mode=max'

outputs:
  digest:
    description: 'Image digest of the built container'
    value: ${{ steps.build.outputs.digest }}
  tags:
    description: 'Full image tags that were pushed'
    value: ${{ steps.meta.outputs.tags }}
  metadata:
    description: 'Build metadata (JSON)'
    value: ${{ steps.meta.outputs.json }}

runs:
  using: 'composite'
  steps:
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ inputs.registry }}
        username: ${{ inputs.registry-username }}
        password: ${{ inputs.registry-password }}

    - name: Extract metadata (tags, labels)
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ inputs.registry }}/${{ inputs.image-name }}
        tags: ${{ inputs.image-tags }}

    - name: Build and push container image
      id: build
      uses: docker/build-push-action@v5
      with:
        context: ${{ inputs.context }}
        file: ${{ inputs.dockerfile }}
        platforms: ${{ inputs.platforms }}
        push: ${{ inputs.push }}
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        build-args: ${{ inputs.build-args }}
        cache-from: ${{ inputs.cache-from }}
        cache-to: ${{ inputs.cache-to }}

    - name: Output image information
      shell: bash
      run: |
        echo "### Container Build Summary ðŸ“¦" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Image:** \`${{ inputs.registry }}/${{ inputs.image-name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Digest:** \`${{ steps.build.outputs.digest }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Tags:**" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "**Platforms:** \`${{ inputs.platforms }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Pushed:** \`${{ inputs.push }}\`" >> $GITHUB_STEP_SUMMARY
